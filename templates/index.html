<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ BananaDB - AI åœ–ç‰‡è³‡æ–™åº«</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background-color: #0F0F0F;
            color: #FFFFFF;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* ç€‘å¸ƒæµå¸ƒå±€ï¼ˆMasonry Gridï¼‰*/
        .masonry-grid {
            column-count: 4;
            column-gap: 1rem;
        }

        @media (min-width: 1920px) {
            .masonry-grid {
                column-count: 5;
            }
        }

        @media (max-width: 1280px) {
            .masonry-grid {
                column-count: 3;
            }
        }

        @media (max-width: 1024px) {
            .masonry-grid {
                column-count: 2;
            }
        }

        @media (max-width: 640px) {
            .masonry-grid {
                column-count: 1;
            }
        }

        .masonry-item {
            break-inside: avoid;
            margin-bottom: 1rem;
        }

        /* æ‹–æ”¾ä¸Šå‚³å€åŸŸæ¨£å¼ */
        #dropZone {
            border: 2px dashed #FFD700;
            transition: all 0.3s ease;
        }

        #dropZone.drag-over {
            background-color: rgba(255, 215, 0, 0.1);
            border-color: #FFA500;
        }

        /* è¤‡è£½æŒ‰éˆ•å‹•ç•« */
        .copy-btn {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background-color: rgba(255, 215, 0, 0.2);
        }

        /* æ¨™ç±¤æ¨£å¼ */
        .tag {
            background-color: rgba(255, 215, 0, 0.15);
            color: #FFD700;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            display: inline-block;
            margin: 0.25rem;
        }

        /* è¼‰å…¥å‹•ç•« */
        .spinner {
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-top: 3px solid #FFD700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* å¤šé¸æ¨¡å¼æ¨£å¼ */
        .selection-mode .masonry-item {
            position: relative;
            cursor: pointer;
        }

        .masonry-item .checkbox-overlay {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
        }

        .selection-mode .checkbox-overlay {
            display: block;
        }

        .checkbox-overlay input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #FFD700;
        }

        .selection-mode .masonry-item.selected {
            outline: 3px solid #FFD700;
            outline-offset: -3px;
        }

        /* æç¤ºè©æ‘ºç–Šæ¨£å¼ */
        .prompt-text {
            position: relative;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .prompt-text.collapsed {
            max-height: 4.5em;
            /* ç´„ 3 è¡Œ */
            line-height: 1.5em;
        }

        .prompt-text.expanded {
            max-height: none;
        }

        .expand-btn {
            color: #FFD700;
            cursor: pointer;
            font-size: 12px;
            margin-top: 4px;
            display: inline-block;
            text-decoration: underline;
            user-select: none;
        }

        .expand-btn:hover {
            color: #FFA500;
        }

        /* å›åˆ°é ‚éƒ¨æŒ‰éˆ• */
        #scrollToTop {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
            z-index: 1000;
        }

        #scrollToTop.show {
            opacity: 1;
            visibility: visible;
        }

        #scrollToTop:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
            background: linear-gradient(135deg, #FFA500, #FFD700);
        }

        #scrollToTop:active {
            transform: translateY(-2px) scale(1.05);
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- æ¨™é¡Œåˆ—èˆ‡æœå°‹ -->
    <header class="sticky top-0 z-50 bg-gray-900 border-b border-gray-800 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <!-- ç¬¬ä¸€è¡Œï¼šæ¨™é¡Œ + æœå°‹æ¬„ -->
            <div class="flex items-center gap-4 mb-2">
                <!-- ç¸®å°çš„æ¨™é¡Œ -->
                <h1 class="text-2xl font-bold cursor-pointer flex-shrink-0" onclick="resetSearch()">
                    ğŸŒ <span style="color: #FFD700;">Banana</span>DB
                </h1>

                <!-- æœå°‹æ¬„ï¼ˆæ›´ç·Šæ¹Šï¼‰-->
                <div class="flex-1 relative">
                    <input type="text" id="searchInput"
                        class="w-full bg-gray-800 border border-gray-700 text-white px-10 py-2 rounded-full text-sm focus:outline-none focus:border-yellow-500 transition-colors"
                        placeholder="AI Search: æè¿°ä½ æƒ³æ‰¾çš„åœ–ç‰‡..." onkeypress="handleSearch(event)">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-lg">ğŸ”</span>
                    <button onclick="performSearch()"
                        class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-yellow-500 text-black px-4 py-1 rounded-full text-xs font-bold hover:bg-yellow-400 transition">
                        Search
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- åˆ†é¡ç¯©é¸åˆ—ï¼ˆç·Šæ¥åœ¨ header ä¸‹æ–¹ï¼‰-->
    <section class="sticky top-[65px] z-40 bg-gray-900 border-t border-gray-800 py-2 px-4">
        <div class="max-w-7xl mx-auto overflow-x-auto">
            <div id="categoriesBar" class="flex gap-2" style="min-width: max-content;">
                <!-- åˆ†é¡æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </section>

    <!-- ä¸Šå‚³å€åŸŸ -->
    <section class="py-8 px-6">
        <div class="max-w-7xl mx-auto">
            <div id="dropZone" class="rounded-lg p-12 text-center">
                <input type="file" id="fileInput" accept="image/*" class="hidden">
                <div id="uploadContent">
                    <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                        </path>
                    </svg>
                    <p class="mt-4 text-xl text-gray-300">æ‹–æ”¾åœ–ç‰‡è‡³æ­¤è™•ä¸Šå‚³</p>
                    <p class="mt-2 text-sm text-gray-500">æˆ–</p>
                    <button onclick="document.getElementById('fileInput').click()"
                        class="mt-4 px-6 py-2 bg-yellow-500 text-black rounded-lg font-semibold hover:bg-yellow-400 transition">
                        é¸æ“‡æª”æ¡ˆ
                    </button>
                </div>
                <div id="uploadingContent" class="hidden">
                    <div class="spinner mx-auto"></div>
                    <p class="mt-4 text-xl text-yellow-500">æ­£åœ¨åˆ†æåœ–ç‰‡...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- åœ–åº«å€åŸŸ -->
    <section class="py-8 px-6">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                <h2 class="text-3xl font-bold" style="color: #FFD700;">åœ–ç‰‡åœ–åº«</h2>
                <div class="flex gap-3">
                    <button id="toggleSelectionBtn" onclick="toggleSelectionMode()"
                        class="px-4 py-2 bg-gray-800 rounded-lg hover:bg-gray-700 transition">
                        â˜‘ï¸ å¤šé¸æ¨¡å¼
                    </button>
                    <button id="deleteSelectedBtn" onclick="deleteSelected()"
                        class="hidden px-4 py-2 bg-red-600 rounded-lg hover:bg-red-700 transition">
                        ğŸ—‘ï¸ åˆªé™¤é¸å– (<span id="selectedCount">0</span>)
                    </button>
                    <button onclick="loadGallery()"
                        class="px-4 py-2 bg-gray-800 rounded-lg hover:bg-gray-700 transition">
                        ğŸ”„ é‡æ–°æ•´ç†
                    </button>
                </div>
            </div>

            <!-- æœå°‹çµæœæç¤º -->
            <div id="searchResultsInfo" class="hidden mb-6 text-center">
                <p class="text-xl text-white">ğŸ” æœå°‹çµæœ: <span id="searchQueryDisplay"
                        class="text-yellow-500 font-bold"></span></p>
                <button onclick="resetSearch()" class="mt-2 text-gray-400 hover:text-white underline text-sm">
                    æ¸…é™¤æœå°‹ï¼Œé¡¯ç¤ºå…¨éƒ¨
                </button>
            </div>

            <!-- è¼‰å…¥ä¸­ -->
            <div id="loadingIndicator" class="text-center py-12">
                <div class="spinner mx-auto"></div>
                <p id="loadingText" class="mt-4 text-gray-400">è¼‰å…¥ä¸­...</p>
            </div>

            <!-- ç©ºç‹€æ…‹ -->
            <div id="emptyState" class="hidden text-center py-12">
                <p class="text-2xl text-gray-500">å°šæœªæœ‰åœ–ç‰‡</p>
                <p class="text-gray-600 mt-2">ä¸Šå‚³åœ–ç‰‡æˆ–ä½¿ç”¨ Chrome æ“´å……åŠŸèƒ½æ”¶é›†åœ–ç‰‡</p>
            </div>

            <!-- ç€‘å¸ƒæµåœ–åº« -->
            <div id="gallery" class="masonry-grid hidden"></div>
        </div>
    </section>

    <!-- é€šçŸ¥æç¤º -->
    <div id="toast" class="hidden fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transition-all"></div>

    <!-- å›åˆ°é ‚éƒ¨æŒ‰éˆ• -->
    <div id="scrollToTop" title="å›åˆ°é ‚éƒ¨">
        â¬†ï¸
    </div>

    <script>
        // ========== å…¨åŸŸè®Šæ•¸ ==========
        const API_BASE = window.location.origin;
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const gallery = document.getElementById('gallery');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const emptyState = document.getElementById('emptyState');
        const uploadContent = document.getElementById('uploadContent');
        const uploadingContent = document.getElementById('uploadingContent');
        const searchInput = document.getElementById('searchInput');
        const searchResultsInfo = document.getElementById('searchResultsInfo');
        const searchQueryDisplay = document.getElementById('searchQueryDisplay');
        const loadingText = document.getElementById('loadingText');
        const categoriesBar = document.getElementById('categoriesBar');
        const scrollToTopBtn = document.getElementById('scrollToTop');

        // å¤šé¸æ¨¡å¼ç‹€æ…‹
        let isSelectionMode = false;
        let selectedImages = new Set();

        // åˆ†é¡ç‹€æ…‹
        let categoriesData = [];
        let currentCategory = null;

        // ========== å›åˆ°é ‚éƒ¨æŒ‰éˆ•åŠŸèƒ½ ==========
        // ç›£è½æ»¾å‹•ï¼Œé¡¯ç¤º/éš±è—æŒ‰éˆ•
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
        });

        // é»æ“ŠæŒ‰éˆ•å¹³æ»‘æ»¾å‹•å›é ‚éƒ¨
        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // ========== æ‹–æ”¾ä¸Šå‚³äº‹ä»¶ ==========
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadImage(files[0]);
            }
        });

        // æª”æ¡ˆé¸æ“‡ä¸Šå‚³
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                uploadImage(e.target.files[0]);
            }
        });

        // ========== ä¸Šå‚³åœ–ç‰‡å‡½å¼ ==========
        async function uploadImage(file) {
            if (!file.type.startsWith('image/')) {
                showToast('åªèƒ½ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ', 'error');
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            uploadContent.classList.add('hidden');
            uploadingContent.classList.remove('hidden');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`ä¸Šå‚³å¤±æ•—: HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    showToast('âœ… åœ–ç‰‡ä¸Šå‚³æˆåŠŸ', 'success');
                    // é‡æ–°è¼‰å…¥åœ–åº«
                    setTimeout(() => loadGallery(), 1000);
                } else {
                    throw new Error(result.message || 'ä¸Šå‚³å¤±æ•—');
                }

            } catch (error) {
                console.error('ä¸Šå‚³éŒ¯èª¤:', error);
                showToast('âŒ ' + error.message, 'error');
            } finally {
                // æ¢å¾©ä¸Šå‚³å€åŸŸ
                uploadContent.classList.remove('hidden');
                uploadingContent.classList.add('hidden');
                fileInput.value = '';
            }
        }

        // ========== è¼‰å…¥åœ–åº«å‡½å¼ ==========
        async function loadGallery() {
            loadingIndicator.classList.remove('hidden');
            gallery.classList.add('hidden');
            emptyState.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE}/api/images`);

                if (!response.ok) {
                    throw new Error(`è¼‰å…¥å¤±æ•—: HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    renderGallery(result.data);
                    gallery.classList.remove('hidden');
                } else {
                    emptyState.classList.remove('hidden');
                }

            } catch (error) {
                console.error('è¼‰å…¥éŒ¯èª¤:', error);
                showToast('âŒ åœ–åº«è¼‰å…¥å¤±æ•—', 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // ========== æ¸²æŸ“åœ–åº«å‡½å¼ ==========
        function renderGallery(images) {
            gallery.innerHTML = '';

            images.forEach(image => {
                const card = createImageCard(image);
                gallery.appendChild(card);
            });
        }

        // ========== å»ºç«‹åœ–ç‰‡å¡ç‰‡å‡½å¼ ==========
        function createImageCard(image) {
            const div = document.createElement('div');
            div.className = 'masonry-item bg-gray-900 rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition';
            div.dataset.imageId = image.id;

            const imageUrl = `${API_BASE}/uploads/${image.filename}`;

            div.innerHTML = `
                <div class="checkbox-overlay">
                    <input type="checkbox" onchange="toggleImageSelection(${image.id})" ${selectedImages.has(image.id) ? 'checked' : ''}>
                </div>
                <img src="${imageUrl}" alt="Image ${image.id}" class="w-full h-auto">
                <div class="p-4">
                    <!-- è‹±æ–‡æç¤ºè© -->
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-500 font-semibold">ENGLISH PROMPT</span>
                            <button onclick="copyToClipboard('${escapeHtml(image.positive_prompt)}', 'en')" 
                                    class="copy-btn text-xs px-2 py-1 rounded bg-gray-800 hover:bg-yellow-900">
                                ğŸ“‹ è¤‡è£½
                            </button>
                        </div>
                        <div id="prompt-en-${image.id}" class="prompt-text collapsed">
                            <p class="text-sm text-gray-300 leading-relaxed">${escapeHtml(image.positive_prompt)}</p>
                        </div>
                        ${needsExpand(image.positive_prompt) ? `<span class="expand-btn" onclick="togglePrompt('prompt-en-${image.id}', this)">... å±•é–‹</span>` : ''}
                    </div>
                    
                    <!-- ä¸­æ–‡æç¤ºè© -->
                    ${image.positive_prompt_zh ? `
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-yellow-500 font-semibold">ç¹é«”ä¸­æ–‡æç¤ºè©</span>
                            <button onclick="copyToClipboard('${escapeHtml(image.positive_prompt_zh)}', 'zh')" 
                                    class="copy-btn text-xs px-2 py-1 rounded bg-gray-800 hover:bg-yellow-900">
                                ğŸ“‹ è¤‡è£½
                            </button>
                        </div>
                        <div id="prompt-zh-${image.id}" class="prompt-text collapsed">
                            <p class="text-sm text-yellow-100 leading-relaxed">${escapeHtml(image.positive_prompt_zh)}</p>
                        </div>
                        ${needsExpand(image.positive_prompt_zh) ? `<span class="expand-btn" onclick="togglePrompt('prompt-zh-${image.id}', this)">... å±•é–‹</span>` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- è² é¢æç¤ºè© -->
                    ${image.negative_prompt ? `
                    <div class="mb-3">
                        <span class="text-xs text-gray-500 font-semibold">NEGATIVE PROMPT</span>
                        <div id="prompt-neg-${image.id}" class="prompt-text collapsed">
                            <p class="text-xs text-gray-500 mt-1">${escapeHtml(image.negative_prompt)}</p>
                        </div>
                        ${needsExpand(image.negative_prompt) ? `<span class="expand-btn" onclick="togglePrompt('prompt-neg-${image.id}', this)">... å±•é–‹</span>` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- æ¨™ç±¤ -->
                    ${image.tags && image.tags.length > 0 ? `
                    <div class="mb-3">
                        ${image.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                    </div>
                    ` : ''}
                    
                    <!-- åˆ†é¡æ¨™ç±¤ -->
                    ${image.category && image.category !== 'Other' ? `
                    <div class="mb-2">
                        <span class="inline-block px-2 py-1 rounded text-xs font-bold ${getCategoryColor(image.category)} text-white">
                            ${getCategoryLabel(image.category)}
                        </span>
                    </div>
                    ` : ''}
                    
                    <!-- ä¾†æº URL -->
                    ${image.source_url ? `
                    <div class="text-xs text-gray-600">
                        <a href="${escapeHtml(image.source_url)}" target="_blank" class="hover:text-yellow-500">
                            ğŸ”— ä¾†æºé€£çµ
                        </a>
                    </div>
                    ` : ''}
                    
                    <!-- æ™‚é–“æˆ³è¨˜èˆ‡åˆªé™¤æŒ‰éˆ• -->
                    <div class="flex justify-between items-center mt-2">
                        <div class="text-xs text-gray-700">
                            ${new Date(image.created_at).toLocaleString('zh-TW')}
                        </div>
                        <button onclick="deleteSingleImage(${image.id})" class="text-xs px-3 py-1 bg-red-600 rounded hover:bg-red-700 transition">
                            ğŸ—‘ï¸ åˆªé™¤
                        </button>
                    </div>
                </div>
            `;

            if (selectedImages.has(image.id)) {
                div.classList.add('selected');
            }

            // ç‚ºå¡ç‰‡æ·»åŠ é»æ“Šäº‹ä»¶ï¼ˆå¤šé¸æ¨¡å¼ä¸‹é»æ“Šæ•´å¼µå¡ç‰‡å³å¯å‹¾é¸ï¼‰
            div.addEventListener('click', (e) => {
                // åªåœ¨å¤šé¸æ¨¡å¼ä¸‹è§¸ç™¼
                if (!isSelectionMode) return;

                // æ’é™¤é»æ“ŠæŒ‰éˆ•ã€inputã€checkbox ç­‰äº’å‹•å…ƒç´ 
                const clickedElement = e.target;
                const isButton = clickedElement.tagName === 'BUTTON' || clickedElement.closest('button');
                const isInput = clickedElement.tagName === 'INPUT';
                const isCheckbox = clickedElement.type === 'checkbox';
                const isLink = clickedElement.tagName === 'A' || clickedElement.closest('a');

                // å¦‚æœé»æ“Šçš„æ˜¯äº’å‹•å…ƒç´ ï¼Œä¸è§¸ç™¼å¡ç‰‡é¸æ“‡
                if (isButton || isInput || isCheckbox || isLink) {
                    return;
                }

                // åˆ‡æ›é¸æ“‡ç‹€æ…‹
                toggleImageSelection(image.id);

                // åŒæ­¥æ›´æ–° checkbox ç‹€æ…‹
                const checkbox = div.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = selectedImages.has(image.id);
                }
            });

            return div;
        }

        // ========== æç¤ºè©å±•é–‹/æ”¶åˆå‡½å¼ ==========
        function needsExpand(text) {
            if (!text) return false;
            // ç°¡å–®åˆ¤æ–·ï¼šè¶…é 150 å­—å…ƒæˆ–æœ‰å¤šè¡Œ
            return text.length > 150 || text.split('\n').length > 3;
        }

        function togglePrompt(elementId, button) {
            const element = document.getElementById(elementId);
            const isCollapsed = element.classList.contains('collapsed');

            if (isCollapsed) {
                element.classList.remove('collapsed');
                element.classList.add('expanded');
                button.textContent = 'æ”¶åˆ';
            } else {
                element.classList.add('collapsed');
                element.classList.remove('expanded');
                button.textContent = '... å±•é–‹';
            }
        }

        // ========== è¤‡è£½åˆ°å‰ªè²¼ç°¿å‡½å¼ ==========
        function copyToClipboard(text, lang) {
            navigator.clipboard.writeText(text).then(() => {
                const langText = lang === 'zh' ? 'ä¸­æ–‡' : 'è‹±æ–‡';
                showToast(`âœ… å·²è¤‡è£½${langText}æç¤ºè©`, 'success');
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                showToast('âŒ è¤‡è£½å¤±æ•—', 'error');
            });
        }

        // ========== HTML è·³è„«å‡½å¼ ==========
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, '&apos;');
        }

        // ========== é¡¯ç¤ºæç¤ºè¨Šæ¯å‡½å¼ ==========
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transition-all ${type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' :
                    'bg-gray-700'
                }`;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // ========== å¤šé¸èˆ‡åˆªé™¤åŠŸèƒ½ ==========
        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode;
            const btn = document.getElementById('toggleSelectionBtn');
            const deleteBtn = document.getElementById('deleteSelectedBtn');

            if (isSelectionMode) {
                gallery.classList.add('selection-mode');
                btn.textContent = 'âœ… å–æ¶ˆå¤šé¸';
                btn.classList.add('bg-yellow-600');
                deleteBtn.classList.remove('hidden');
            } else {
                gallery.classList.remove('selection-mode');
                btn.textContent = 'â˜‘ï¸ å¤šé¸æ¨¡å¼';
                btn.classList.remove('bg-yellow-600');
                deleteBtn.classList.add('hidden');
                selectedImages.clear();
                updateSelectedCount();
            }
        }

        function toggleImageSelection(imageId) {
            const card = document.querySelector(`[data-image-id="${imageId}"]`);

            if (selectedImages.has(imageId)) {
                selectedImages.delete(imageId);
                card.classList.remove('selected');
            } else {
                selectedImages.add(imageId);
                card.classList.add('selected');
            }

            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedImages.size;
        }

        async function deleteSingleImage(imageId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åœ–ç‰‡å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/api/images/${imageId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`åˆªé™¤å¤±æ•—: HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    showToast('âœ… åœ–ç‰‡å·²åˆªé™¤', 'success');
                    loadGallery();
                } else {
                    throw new Error(result.message || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                console.error('åˆªé™¤éŒ¯èª¤:', error);
                showToast('âŒ ' + error.message, 'error');
            }
        }

        async function deleteSelected() {
            if (selectedImages.size === 0) {
                showToast('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„åœ–ç‰‡', 'error');
                return;
            }

            if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¸å–çš„ ${selectedImages.size} å¼µåœ–ç‰‡å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`${API_BASE}/api/images/delete_batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_ids: Array.from(selectedImages)
                    })
                });

                if (!response.ok) {
                    throw new Error(`æ‰¹æ¬¡åˆªé™¤å¤±æ•—: HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    showToast(`âœ… æˆåŠŸåˆªé™¤ ${result.data.deleted_count} å¼µåœ–ç‰‡`, 'success');
                    selectedImages.clear();
                    updateSelectedCount();
                    loadGallery();
                } else {
                    throw new Error(result.message || 'æ‰¹æ¬¡åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                console.error('æ‰¹æ¬¡åˆªé™¤éŒ¯èª¤:', error);
                showToast('âŒ ' + error.message, 'error');
            }
        }

        // ========== åˆ†é¡åŠŸèƒ½ ==========
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/api/categories`);
                const result = await response.json();

                if (result.success) {
                    categoriesData = result.data;
                    renderCategories();
                }
            } catch (error) {
                console.error('åˆ†é¡è¼‰å…¥å¤±æ•—:', error);
            }
        }

        function renderCategories() {
            categoriesBar.innerHTML = '';

            // ã€Œå…¨éƒ¨ã€æŒ‰éˆ•
            const allBtn = createCategoryButton(
                { id: null, label: 'å…¨éƒ¨', count: categoriesData.reduce((sum, cat) => sum + cat.count, 0), color: 'bg-yellow-500' },
                true
            );
            categoriesBar.appendChild(allBtn);

            // å„åˆ†é¡æŒ‰éˆ•
            categoriesData.forEach(cat => {
                if (cat.count > 0) {  // åªé¡¯ç¤ºæœ‰åœ–ç‰‡çš„åˆ†é¡
                    const btn = createCategoryButton(cat);
                    categoriesBar.appendChild(btn);
                }
            });
        }

        function createCategoryButton(category, isAll = false) {
            const btn = document.createElement('button');
            const isActive = isAll ? (currentCategory === null) : (currentCategory === category.id);

            btn.className = `px-3 py-1 rounded-full font-semibold text-xs transition hover:scale-105 ${isActive ? category.color + ' text-white shadow-md' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                }`;

            btn.textContent = `${category.label} (${category.count})`;
            btn.onclick = () => filterByCategory(isAll ? null : category.id);

            return btn;
        }

        async function filterByCategory(categoryId) {
            currentCategory = categoryId;
            searchResultsInfo.classList.add('hidden');

            loadingIndicator.classList.remove('hidden');
            gallery.classList.add('hidden');
            emptyState.classList.add('hidden');

            try {
                const url = categoryId
                    ? `${API_BASE}/api/images?category=${encodeURIComponent(categoryId)}`
                    : `${API_BASE}/api/images`;

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    renderCategories();  // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    if (result.data.length > 0) {
                        renderGallery(result.data);
                        gallery.classList.remove('hidden');
                    } else {
                        emptyState.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('åˆ†é¡ç¯©é¸å¤±æ•—:', error);
                showToast('âŒ ç¯©é¸å¤±æ•—', 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function getCategoryColor(categoryId) {
            const cat = categoriesData.find(c => c.id === categoryId);
            return cat ? cat.color : 'bg-gray-500';
        }

        function getCategoryLabel(categoryId) {
            const cat = categoriesData.find(c => c.id === categoryId);
            return cat ? cat.label : categoryId;
        }

        // ========== æœå°‹åŠŸèƒ½ ==========
        function handleSearch(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        async function performSearch() {
            const query = searchInput.value.trim();
            if (!query) return;

            // UI ç‹€æ…‹æ›´æ–°
            gallery.classList.add('hidden');
            emptyState.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            loadingText.textContent = "âœ¨ AI æ­£åœ¨æ€è€ƒä¸¦æœå°‹åœ–ç‰‡ä¸­...";

            try {
                const response = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(query)}`);

                if (!response.ok) {
                    throw new Error(`æœå°‹å¤±æ•—: HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // æ›´æ–°çµæœæç¤º
                    searchResultsInfo.classList.remove('hidden');
                    searchQueryDisplay.textContent = query;

                    if (result.data.length > 0) {
                        renderGallery(result.data);
                        gallery.classList.remove('hidden');
                        showToast(`ğŸ” æ‰¾åˆ° ${result.data.length} å¼µç›¸é—œåœ–ç‰‡`, 'success');
                    } else {
                        emptyState.classList.remove('hidden');
                        showToast('æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åœ–ç‰‡', 'info');
                    }
                }
            } catch (error) {
                console.error('æœå°‹éŒ¯èª¤:', error);
                showToast('âŒ æœå°‹å¤±æ•—', 'error');
                loadingIndicator.classList.add('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                loadingText.textContent = "è¼‰å…¥ä¸­...";
            }
        }

        function resetSearch() {
            searchInput.value = '';
            searchResultsInfo.classList.add('hidden');
            currentCategory = null;
            loadGallery();
        }

        // ========== é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥åœ–åº« ==========
        window.addEventListener('load', () => {
            loadCategories();  // è¼‰å…¥åˆ†é¡
            loadGallery();     // è¼‰å…¥åœ–åº«
        });
    </script>
</body>

</html>